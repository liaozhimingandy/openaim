# ========================
# GitHub Actions: 自动构建并部署 Vue3 静态站点到 GitHub Pages
# 触发条件：
#   1. main 分支有 push
#   2. 推送了符合 v* 格式的标签 (如 v1.0.0)
#   3. 手动触发（workflow_dispatch）
# ========================

name: Deploy vue3 site to Pages

on:
  push:
    branches:
      - main       # 监听 main 分支的推送
    tags:
      - 'v*'       # 监听符合 v* 格式的标签
  workflow_dispatch:  # 允许手动触发工作流

# 配置 GitHub Token 的权限：
# contents: 只读（拉代码）
# pages: 写权限（推送页面到 Pages）
# id-token: 用于 OIDC 认证（GitHub Pages 需要）
permissions:
  contents: read
  pages: write
  id-token: write

# 确保一次只有一个 Pages 部署任务，防止并发冲突
concurrency:
  group: pages-${{ github.ref }}   # 按分支/标签区分任务组
  cancel-in-progress: true         # 如果有新的部署任务，则取消旧的

jobs:
  # ========================
  # 1. 构建任务（Build）
  # ========================
  build:
    runs-on: ubuntu-latest    # 使用 GitHub 提供的 Ubuntu 构建环境
    steps:
      # 拉取代码
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1   # 仅拉取最新一次提交（减少时间）

      # 安装 Node 环境并缓存 npm 依赖
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'         # 使用 Node LTS 版本（稳定性最佳）
          cache: npm                    # 自动缓存 npm 依赖，加速重复构建
          cache-dependency-path: package-lock.json

      # 配置 GitHub Pages 环境（必需步骤）
      - name: Setup Pages
        uses: actions/configure-pages@v4

      # 安装依赖（根据 lock 文件保证版本一致）
      - name: Install dependencies
        run: npm ci

      # 运行 Vue3 构建任务
      - name: Build with Vue3
        run: |
          npm run build
          # 复制 index.html 为 404.html，解决 GitHub Pages SPA 刷新 404 问题
          cp dist/index.html dist/404.html

      # 将构建产物（dist 目录）上传为 artifact，供部署任务使用
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  # ========================
  # 2. 部署任务（Deploy）
  # ========================
  deploy:
    environment:
      name: github-pages                     # 环境名称（用于 GitHub Pages）
      url: ${{ steps.deployment.outputs.page_url }}  # 部署完成后显示访问地址
    needs: build                             # 必须等待 build 任务完成
    runs-on: ubuntu-latest
    steps:
      # 将上一步上传的构建产物部署到 GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4